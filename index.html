<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Code Studio V23 - Stable</title>
    <style>
        /* --- VARI√ÅVEIS --- */
        :root {
            --primary: #007bff;
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --text-main: #333333;
            --border: #e0e0e0;
            --editor-bg: #f8f9fa; /* Fundo claro para editor padr√£o */
            --editor-text: #212529;
            --toolbar-bg: #e9ecef;
        }

        body.dark-theme {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #ffffff;
            --border: #333333;
            --editor-bg: #1e1e1e;
            --editor-text: #d4d4d4;
            --toolbar-bg: #252526;
        }

        body, html {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100%; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            background: var(--bg-card); padding: 12px 18px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); z-index: 10;
            border-bottom: 1px solid var(--border);
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; }
        
        .theme-btn {
            background: none; border: 1px solid var(--border); 
            color: var(--text-main); padding: 5px 10px; border-radius: 20px;
            cursor: pointer; font-size: 1.2rem;
        }

        /* --- MAIN --- */
        main { flex: 1; padding: 15px; overflow-y: auto; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 650px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 80px; }

        .tabs { display: flex; background: var(--border); border-radius: 10px; padding: 4px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; color: var(--text-main); cursor: pointer; border-radius: 8px; opacity: 0.6; }
        .tab-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 6px rgba(0,0,0,0.1); opacity: 1; }

        .view { display: none; }
        .view.active { display: block; }

        /* --- UPLOAD --- */
        .upload-card {
            background: var(--bg-card); border: 2px dashed var(--border); border-radius: 15px; padding: 50px 20px;
            text-align: center; cursor: pointer; position: relative;
        }
        input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* --- EDITOR --- */
        .editor-wrapper {
            display: flex; flex-direction: column; height: 580px;
            border-radius: 12px; overflow: hidden; background: var(--editor-bg);
            border: 1px solid var(--border); position: relative;
        }
        .editor-wrapper.fullscreen-mode {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 4000; border-radius: 0;
        }

        /* Sub-Abas */
        .code-tabs-bar {
            display: flex; background: #222; padding: 5px; gap: 5px; align-items: center;
        }
        .code-tab-btn {
            flex: 1; background: #444; color: #ccc; border: none; padding: 8px;
            cursor: pointer; font-family: monospace; font-weight: bold; border-radius: 4px;
            font-size: 13px;
        }
        .code-tab-btn.active { background: #555; color: white; border-top: 3px solid var(--primary); }
        .code-tab-btn.active.css-mode { border-top-color: #98c379; }
        .code-tab-btn.active.js-mode { border-top-color: #e5c07b; }
        
        .mode-switch-btn {
            background: #6c5ce7; color: white; border: none; padding: 5px 10px;
            border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; margin-left: 5px;
        }

        /* √Årea de Texto Limpa (Sem Overlay) */
        .code-container { flex: 1; position: relative; }
        
        textarea.code-input {
            width: 100%; height: 100%; border: none; padding: 15px;
            background: var(--editor-bg); color: var(--editor-text);
            font-family: 'Menlo', 'Consolas', monospace; font-size: 14px;
            resize: none; outline: none; white-space: pre; line-height: 1.5;
            display: none; /* Escondido por padr√£o, ativado via JS */
        }
        textarea.code-input.active { display: block; }

        /* TOOLBAR */
        .toolbar {
            background: var(--toolbar-bg); padding: 10px; display: flex; gap: 8px; overflow-x: auto;
            border-bottom: 1px solid var(--border); -webkit-overflow-scrolling: touch;
        }
        .toolbar::-webkit-scrollbar { display: none; }
        
        .tool-btn {
            background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 6px; font-size: 13px; font-family: monospace;
            cursor: pointer; white-space: nowrap; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:active { background: #ddd; transform: translateY(1px); }
        .tb-ctrl { background: #555; color: #fff; border-color: #777; }
        
        /* Cores Especiais */
        .tb-blue { color: #007bff; border-color: #007bff; background: rgba(0, 123, 255, 0.1); }
        .tb-green { color: #28a745; border-color: #28a745; background: rgba(40, 167, 69, 0.1); }
        .tb-orange { color: #fd7e14; border-color: #fd7e14; background: rgba(253, 126, 20, 0.1); }

        /* BOT√ïES A√á√ÉO */
        .action-row { display: flex; gap: 10px; margin-top: 5px; height: 50px; }
        .btn { border: none; border-radius: 10px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-trash { background: #dc3545; width: 60px; font-size: 1.2rem; }
        .btn-dl { background: #007bff; flex: 1; }
        .btn-run { background: #28a745; flex: 1; }

        /* LISTA PROJETOS */
        .recent-section { margin-top: 30px; }
        .recent-list { list-style: none; padding: 0; margin: 0; }
        .recent-item {
            background: var(--bg-card); border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }
        .item-header { display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: bold; font-size: 1rem; cursor: pointer; flex: 1; }
        .item-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 5px; }
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; border:none; color:white; cursor:pointer; font-weight:bold; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: #dc3545; }
        .bg-orange { background: #ff9800; }

        .pix-container { margin-top: 30px; background: #fffbe6; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #ffe58f; color: #555; }
        .pix-key { font-weight: bold; color: #333; background: rgba(255,255,255,0.5); padding: 5px; margin-top: 5px; display: block; user-select: text; }
        
        #game-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: none; flex-direction: column; }
        iframe { flex: 1; border: none; background: #fff; width: 100%; }
        .close-game { position: absolute; top: 15px; right: 15px; background: rgba(255, 68, 68, 0.9); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 7000; display:flex; align-items:center; justify-content:center;}
        @media screen and (orientation: landscape) { .close-game { display: none; } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <h1>üíª Code Studio</h1>
        <button class="theme-btn" onclick="toggleTheme()" id="theme-icon">üåô</button>
    </header>

    <main>
        <div class="container">
            
            <div class="tabs">
                <button class="tab-btn" onclick="switchTab('file')">üìÇ Abrir</button>
                <button class="tab-btn active" onclick="switchTab('editor')">üìù Editor</button>
            </div>

            <div id="view-file" class="view">
                <div class="upload-card">
                    <div style="font-size: 50px; margin-bottom: 10px;">üìÑ</div>
                    <strong>Importar Arquivo</strong>
                    <input type="file" onchange="handleFile(this)" accept=".html,.htm">
                </div>
            </div>

            <div id="view-editor" class="view active">
                <div class="editor-wrapper" id="editor-container">
                    
                    <div class="code-tabs-bar" id="split-tabs-bar">
                        <button class="code-tab-btn active" onclick="setSubTab('html')" id="btn-html">HTML</button>
                        <button class="code-tab-btn" onclick="setSubTab('css')" id="btn-css">CSS</button>
                        <button class="code-tab-btn" onclick="setSubTab('js')" id="btn-js">JS</button>
                        <button class="mode-switch-btn" onclick="toggleEditorMode()">üîÑ Mudar Modo</button>
                    </div>

                    <div class="code-tabs-bar hidden" id="single-mode-bar" style="background: #2d3436;">
                        <span style="color:white; font-size:12px; margin-left:10px; flex:1;">üìù MODO √öNICO</span>
                        <button class="mode-switch-btn" style="background:#0984e3;" onclick="toggleEditorMode()">üîÑ Voltar Abas</button>
                    </div>

                    <div class="toolbar">
                        <button class="tool-btn" onclick="toggleEditorFull()">‚õ∂</button>
                        <button class="tool-btn tb-ctrl" onclick="selectAll()">TUDO</button>
                        <button class="tool-btn tb-ctrl" onclick="copyAll()">COPIAR</button>
                        <button class="tool-btn tb-ctrl" onclick="pasteAll()">COLAR</button>
                        <div style="width:1px; background:#aaa; margin:0 5px;"></div>
                        <button class="tool-btn" onclick="undo()">‚Ü©</button>
                        <button class="tool-btn" onclick="redo()">‚Ü™</button>
                        <div style="width:1px; background:#aaa; margin:0 5px;"></div>
                        
                        <button class="tool-btn tb-blue" onclick="insert('<html>\n<body>\n  <h1>Ol√°</h1>\n</body>\n</html>')">HTML</button>
                        <button class="tool-btn tb-green" onclick="insert('body {\n  background: #fff;\n}')">CSS</button>
                        <button class="tool-btn tb-green" onclick="insert('alert(\u0022Ol√°\u0022);')">JS</button>
                        
                        <div style="width:1px; background:#aaa; margin:0 5px;"></div>
                        
                        <button class="tool-btn tb-orange" onclick="insert('<div></div>')">div</button>
                        <button class="tool-btn tb-orange" onclick="insert('<span></span>')">span</button>
                        <button class="tool-btn tb-orange" onclick="insert('<br>')">br</button>
                        <button class="tool-btn tb-orange" onclick="insert('<hr>')">hr</button>
                        <button class="tool-btn" onclick="insert('class=\u0022\u0022')">class</button>
                        <button class="tool-btn" onclick="insert('id=\u0022\u0022')">id</button>
                        <button class="tool-btn" onclick="insert('<img src=\u0022\u0022>')">img</button>
                        <button class="tool-btn" onclick="insert('<a href=\u0022\u0022></a>')">a</button>
                        
                        <div style="width:1px; background:#aaa; margin:0 5px;"></div>
                        
                        <button class="tool-btn" onclick="insert('    ')">TAB</button>
                        <button class="tool-btn" onclick="insert('!')">!</button>
                        <button class="tool-btn" onclick="insert('=')">=</button>
                        <button class="tool-btn" onclick="insert(';')">;</button>
                        <button class="tool-btn" onclick="insert('{ }')">{ }</button>
                        <button class="tool-btn" onclick="insert('<')">&lt;</button>
                        <button class="tool-btn" onclick="insert('>')">&gt;</button>
                    </div>
                    
                    <div class="code-container">
                        <textarea id="in-html" class="code-input active" placeholder="" spellcheck="false" onkeydown="checkTab(event)"></textarea>
                        <textarea id="in-css" class="code-input" placeholder="/* CSS aqui */" spellcheck="false" onkeydown="checkTab(event)"></textarea>
                        <textarea id="in-js" class="code-input" placeholder="// JS aqui" spellcheck="false" onkeydown="checkTab(event)"></textarea>
                        <textarea id="in-single" class="code-input" placeholder="" spellcheck="false" onkeydown="checkTab(event)"></textarea>
                    </div>
                </div>

                <div class="action-row">
                    <button class="btn btn-trash" onclick="clearActiveEditor()">üóëÔ∏è</button>
                    <button class="btn btn-dl" onclick="downloadCode()">üíæ BAIXAR</button>
                    <button class="btn btn-run" onclick="runCode()">‚ñ∂ RODAR</button>
                </div>
            </div>

            <div class="recent-section">
                <span class="recent-title">Meus Projetos</span>
                <ul id="recent-list" class="recent-list"></ul>
                <div style="text-align: right; margin-top:10px;">
                    <small style="color: red; cursor:pointer;" onclick="clearDB()">Limpar Hist√≥rico</small>
                </div>
            </div>

            <div class="pix-container">
                üöÄ <strong>Ajude o Projeto!</strong>
                <span class="pix-key">kenedygabriel65@gmail.com</span>
                <small>Chave PIX (E-mail)</small>
            </div>
        </div>
    </main>

    <div id="game-overlay">
        <button class="close-game" onclick="closeGame()">‚úï</button>
        <iframe id="game-frame"></iframe>
    </div>

    <script>
        // --- ESTADO DO EDITOR ---
        let activeMode = 'html'; // html, css, js
        let editorMode = 'split'; // split ou single
        let currentProjectName = "";

        // --- SISTEMA B√ÅSICO ---
        function checkTab(e) {
            if(e.key == 'Tab') { e.preventDefault(); insert('    '); }
        }

        // --- GERENCIAMENTO DE ABAS ---
        function setSubTab(mode) {
            activeMode = mode;
            // Bot√µes
            document.querySelectorAll('.code-tab-btn').forEach(b => b.classList.remove('active', 'css-mode', 'js-mode'));
            const btn = document.getElementById('btn-' + mode);
            btn.classList.add('active');
            if(mode === 'css') btn.classList.add('css-mode');
            if(mode === 'js') btn.classList.add('js-mode');

            // Textareas
            if(editorMode === 'split') {
                document.querySelectorAll('.code-input').forEach(el => el.classList.remove('active'));
                document.getElementById('in-' + mode).classList.add('active');
            }
        }

        function toggleEditorMode() {
            if(editorMode === 'split') {
                editorMode = 'single';
                document.getElementById('split-tabs-bar').classList.add('hidden');
                document.getElementById('single-mode-bar').classList.remove('hidden');
                document.querySelectorAll('.code-input').forEach(el => el.classList.remove('active'));
                document.getElementById('in-single').classList.add('active');
                
                // Juntar
                document.getElementById('in-single').value = getFullCodeFromTabs();
            } else {
                editorMode = 'split';
                document.getElementById('single-mode-bar').classList.add('hidden');
                document.getElementById('split-tabs-bar').classList.remove('hidden');
                setSubTab(activeMode);
            }
        }

        function getActiveEditor() {
            if(editorMode === 'single') return document.getElementById('in-single');
            return document.getElementById('in-' + activeMode);
        }

        // --- TEMA E DB ---
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
            document.getElementById('theme-icon').innerText = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
        }
        if(localStorage.getItem('theme') === 'dark') toggleTheme();

        const DB_NAME = "StudioDB_V23";
        let db;
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = e => { e.target.result.createObjectStore('projects', { keyPath: 'id', autoIncrement: true }); };
        request.onsuccess = e => { db = e.target.result; renderHistory(); };

        function switchTab(name) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + name).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function toggleEditorFull() { document.getElementById('editor-container').classList.toggle('fullscreen-mode'); }
        
        // --- EDI√á√ÉO SIMPLES ---
        function insert(text) {
            const el = getActiveEditor();
            const start = el.selectionStart;
            el.value = el.value.substring(0, start) + text + el.value.substring(el.selectionEnd);
            el.focus();
            el.selectionStart = el.selectionEnd = start + text.length;
        }

        function undo() { document.execCommand('undo'); }
        function redo() { document.execCommand('redo'); }
        function selectAll() { getActiveEditor().select(); getActiveEditor().focus(); }
        function copyAll() { getActiveEditor().select(); document.execCommand('copy'); }
        async function pasteAll() { 
            try { 
                const text = await navigator.clipboard.readText(); 
                insert(text); 
            } catch(e){ alert('Cole manualmente.'); } 
        }
        function clearActiveEditor() { 
            if(confirm('Limpar editor atual?')) getActiveEditor().value = ""; 
        }

        // --- COMPILA√á√ÉO ---
        function getFullCodeFromTabs() {
            const html = document.getElementById('in-html').value;
            const css = document.getElementById('in-css').value;
            const js = document.getElementById('in-js').value;
            let style = css.trim() ? `\n<style>\n${css}\n</style>` : '';
            let script = js.trim() ? `\n<script>\n${js}\n<\/script>` : '';
            return `${html}${style}${script}`;
        }

        function getCurrentCode() {
            if(editorMode === 'single') return document.getElementById('in-single').value;
            return getFullCodeFromTabs();
        }

        function saveToDB(name) {
            const code = getCurrentCode();
            const tx = db.transaction(['projects'], 'readwrite');
            tx.objectStore('projects').put({ name: name, code: code, date: new Date().toLocaleDateString() });
            tx.oncomplete = renderHistory;
        }

        function runCode() {
            const code = getCurrentCode();
            if(!code.trim()) return;
            if(!currentProjectName) currentProjectName = prompt("Nome do Projeto:") || "Novo Projeto";
            saveToDB(currentProjectName);
            launchGame(code);
        }

        function downloadCode() {
            const code = getCurrentCode();
            const name = prompt("Nome do arquivo:", currentProjectName || "projeto") || "projeto";
            const blob = new Blob([code], {type: 'text/html;charset=utf-8'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name + '.html';
            a.click();
        }

        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                currentProjectName = file.name.replace('.html', '');
                if(editorMode !== 'single') toggleEditorMode(); 
                document.getElementById('in-single').value = e.target.result;
                saveToDB(currentProjectName);
                switchTab('editor');
                alert('Importado no Modo √önico.');
            };
            reader.readAsText(file);
        }

        function renderHistory() {
            if(!db) return;
            const list = document.getElementById('recent-list');
            list.innerHTML = "";
            db.transaction(['projects'], 'readonly').objectStore('projects').getAll().onsuccess = e => {
                const items = e.target.result.reverse();
                if(items.length === 0) list.innerHTML = "<li style='text-align:center; color:#999; padding:20px;'>Sem projetos recentes.</li>";
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'recent-item';
                    li.innerHTML = `
                        <div class="item-header"><span class="item-name" onclick="loadProject(${item.id})">${item.name}</span></div>
                        <div class="item-actions">
                            <button class="btn-sm bg-orange" onclick="renameProject(${item.id}, '${item.name}')">‚úèÔ∏è</button>
                            <button class="btn-sm bg-blue" onclick="downloadProject(${item.id})">BAIXAR</button>
                            <button class="btn-sm bg-red" onclick="deleteProject(${item.id})">APAGAR</button>
                        </div>`;
                    list.appendChild(li);
                });
            };
        }

        function loadProject(id) {
            db.transaction(['projects'], 'readonly').objectStore('projects').get(id).onsuccess = e => {
                const fullCode = e.target.result.code;
                currentProjectName = e.target.result.name;
                if(editorMode !== 'single') toggleEditorMode();
                document.getElementById('in-single').value = fullCode;
                switchTab('editor');
            };
        }

        function renameProject(id, oldName) {
            const newName = prompt("Novo nome:", oldName);
            if(newName && newName !== oldName) {
                const tx = db.transaction(['projects'], 'readwrite');
                const store = tx.objectStore('projects');
                store.get(id).onsuccess = e => { const d = e.target.result; d.name = newName; store.put(d); renderHistory(); };
            }
        }
        function deleteProject(id) { if(confirm('Tem certeza?')) { db.transaction(['projects'], 'readwrite').objectStore('projects').delete(id); setTimeout(renderHistory, 100); } }
        function clearDB() { if(confirm('Apagar tudo?')) { db.transaction(['projects'], 'readwrite').objectStore('projects').clear(); setTimeout(renderHistory, 100); } }
        function downloadProject(id) { db.transaction(['projects'], 'readonly').objectStore('projects').get(id).onsuccess = e => { const b = new Blob([e.target.result.code], {type:'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = e.target.result.name+'.html'; a.click(); }; }

        function launchGame(html) {
            const overlay = document.getElementById('game-overlay');
            const iframe = document.getElementById('game-frame');
            overlay.style.display = 'flex';
            const fix = '<script>try{localStorage}catch(e){window.localStorage={getItem:()=>null,setItem:()=>{}}}<\/script>';
            iframe.srcdoc = html.includes('<head>') ? html.replace('<head>', '<head>' + fix) : fix + html;
        }

        function closeGame() {
            document.getElementById('game-overlay').style.display = 'none';
            document.getElementById('game-frame').srcdoc = "";
        }
    </script>
</body>
</html>
