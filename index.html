<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Code Studio V39 - Landscape</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary: #007bff; --bg-body: #121212; --bg-card: #1e1e1e;
            --text-main: #e0e0e0; --border: #333; --editor-bg: #151515;
            --gutter-bg: #202020; --gutter-text: #666; --console-bg: #111;
        }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100%; width: 100%; overflow: hidden; display: flex; flex-direction: column; }

        header { background: var(--bg-card); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); flex-shrink: 0; transition: 0.3s; }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 10px; }
        .theme-btn { background: none; border: 1px solid var(--border); color: var(--text-main); padding: 5px 10px; border-radius: 20px; cursor: pointer; }

        main { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden; max-width: 900px; margin: 0 auto; width: 100%; transition: 0.3s; }
        
        .nav-tabs { display: flex; background: #252526; border-radius: 12px; padding: 4px; gap: 5px; flex-shrink: 0; margin-bottom: 10px; border: 1px solid var(--border); }
        .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #888; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .nav-btn.active { background: #333; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .view { display: none; height: 100%; flex-direction: column; } .view.active { display: flex; }

        .editor-wrapper { flex: 1; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; background: var(--editor-bg); border: 1px solid var(--border); min-height: 0; position: relative; }
        .editor-wrapper.fullscreen-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 5000; border-radius: 0; border: none; }

        /* MODIFICA√á√ïES PARA PAISAGEM (ZEN MODE) */
        @media screen and (orientation: landscape) {
            header, .nav-tabs { display: none !important; } /* Esconde o topo */
            main { padding: 0 !important; max-width: 100% !important; }
            .editor-wrapper { border-radius: 0; border: none; }
            .recent-section { display: none; } /* Esconde lista de projetos recentes para ganhar espa√ßo */
            .action-row { margin-top: 5px; height: 40px; } /* Bot√µes menores */
            .btn { font-size: 12px; padding: 0 10px; }
        }

        #search-bar { position: absolute; top: 45px; right: 10px; z-index: 20; background: #252526; padding: 6px; border: 1px solid #007bff; border-radius: 8px; display: flex; gap: 5px; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: none; }
        #search-bar.active { display: flex; }
        #search-input { background: #111; border: 1px solid #444; color: white; padding: 6px; width: 130px; border-radius: 4px; outline: none; }
        .search-btn { background: #444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }

        .file-tabs-bar { display: flex; background: #252526; align-items: center; overflow-x: auto; border-bottom: 1px solid var(--border); height: 42px; flex-shrink: 0; }
        .file-tab { padding: 0 15px; height: 100%; display: flex; align-items: center; gap: 8px; background: #2d2d2d; color: #999; font-size: 13px; cursor: pointer; border-right: 1px solid #111; flex-shrink: 0; }
        .file-tab.active { background: #1e1e1e; color: #fff; border-top: 2px solid var(--primary); }
        .tab-controls { display: flex; align-items: center; padding: 0 5px; gap: 5px; background: #252526; height: 100%; margin-left: auto; position: sticky; right: 0; border-left: 1px solid #333; }
        .btn-add-file { background: #28a745; color: white; border: none; width: 30px; height: 30px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-mode { background: #6c5ce7; color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        .code-container { flex: 1; position: relative; background: var(--editor-bg); display: flex; overflow: hidden; }
        .line-numbers { width: 40px; background: var(--gutter-bg); color: var(--gutter-text); text-align: right; padding: 15px 5px; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.5; border-right: 1px solid #333; user-select: none; overflow: hidden; }
        textarea.code-input { flex: 1; height: 100%; border: none; padding: 15px; background: var(--editor-bg); color: #d4d4d4; font-family: 'Consolas', 'Fira Code', monospace; font-size: 13px; resize: none; outline: none; white-space: pre; line-height: 1.5; display: none; overflow: auto; }
        textarea.code-input.active { display: block; }

        #console-pane { position: absolute; bottom: 0; left: 0; width: 100%; height: 40%; background: var(--console-bg); border-top: 2px solid #444; display: flex; flex-direction: column; z-index: 100; transform: translateY(100%); transition: transform 0.3s ease; }
        #console-pane.open { transform: translateY(0); }
        .console-header { padding: 5px 10px; background: #252526; color: #ccc; font-size: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .console-logs { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: #ddd; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; word-break: break-all; }
        .log-input-area { display: flex; border-top: 1px solid #333; background: #111; }
        #console-cmd { flex: 1; background: transparent; color: white; border: none; padding: 10px; outline: none; font-family: monospace; }

        .toolbar { background: #252526; padding: 8px; display: flex; gap: 8px; overflow-x: auto; border-top: 1px solid var(--border); flex-shrink: 0; }
        .tool-btn { background: #333; color: #eee; border: 1px solid #444; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-family: monospace; cursor: pointer; white-space: nowrap; font-weight: bold; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .tool-btn:active { background: var(--primary); transform: translateY(1px); }
        
        .tb-pink { background: #e91e63; color: white; border: none; }
        .tb-purple { background: #9c27b0; color: white; border: none; }
        .tb-app { background: #28a745; color: white; border: none; }
        .tb-link { background: #007bff; color: white; border: none; }

        .action-row { display: flex; gap: 10px; margin-top: 10px; height: 50px; flex-shrink: 0; }
        .btn { border: none; border-radius: 10px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; flex: 1; display:flex; align-items:center; justify-content:center; gap:6px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-trash { background: #d32f2f; max-width: 60px; font-size: 1.2rem; }
        .btn-dl { background: #ff9800; }
        .btn-run { background: #388e3c; }

        .recent-section { margin-top: 15px; overflow-y: auto; max-height: 200px; }
        .recent-item { background: #252526; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: bold; color: #fff; cursor: pointer; text-decoration: underline; text-decoration-color: #555; }
        .btn-act { padding: 6px 12px; font-size: 11px; border-radius: 4px; border:none; color:white; cursor:pointer; font-weight:bold; margin-left: 5px; }
        
        .upload-card { background: #252526; border: 2px dashed #444; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; margin-top: 20px; color: #888; }
        #game-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: none; flex-direction: column; }
        iframe { flex: 1; border: none; background: #fff; width: 100%; }
        .close-game { position: absolute; top: 15px; right: 15px; background: rgba(255, 68, 68, 0.9); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 7000; display:flex; align-items:center; justify-content:center;}
        .hidden { display: none !important; }
        .scroll-view { overflow-y: auto; flex: 1; padding-bottom: 20px; }
        .help-card { background: #252526; border-radius: 12px; padding: 20px; border: 1px solid #333; margin-bottom:15px; }
        .snippet-item { background: #111; padding: 10px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border: 1px solid #333; font-family: monospace; font-size: 12px; color: #88c0d0; }
    </style>
</head>
<body>

    <header>
        <h1>üíª Code Studio <span style="font-size:0.7em; opacity:0.6; margin-left:5px;">V39</span></h1>
    </header>

    <main>
        <div class="nav-tabs">
            <button class="nav-btn" onclick="switchView('file')">üìÇ Abrir</button>
            <button class="nav-btn active" onclick="switchView('editor')">üìù Editor</button>
            <button class="nav-btn" onclick="switchView('help')">üí° Ajuda</button>
        </div>

        <div id="view-file" class="view">
            <div class="scroll-view">
                <div class="upload-card" onclick="document.getElementById('file-import').click()">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìÑ</div>
                    <strong>Importar HTML</strong>
                    <input type="file" id="file-import" style="display:none;" onchange="handleFile(this)" accept=".html,.htm">
                </div>
            </div>
        </div>

        <div id="view-editor" class="view active">
            <div class="editor-wrapper" id="editor-container">
                <div id="search-bar">
                    <input type="text" id="search-input" placeholder="Buscar...">
                    <button class="search-btn" onclick="findNext()">‚¨á</button>
                    <button class="search-btn" onclick="findPrev()">‚¨Ü</button>
                    <button class="search-btn" style="background:transparent; color:#aaa;" onclick="toggleSearch()">‚úï</button>
                </div>
                <div class="file-tabs-bar" id="tabs-container">
                    <div class="tab-controls">
                        <button class="btn-add-file" onclick="addNewFile()">+</button>
                        <button class="btn-mode" onclick="toggleEditorMode()"><span id="mode-icon">üìö</span></button>
                    </div>
                </div>
                <div class="code-container" id="editors-area">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <textarea id="in-single" class="code-input" placeholder="" spellcheck="false" oninput="updateLines()" onscroll="syncScroll()" onkeydown="checkTab(event)"></textarea>
                    
                    <div id="console-pane">
                        <div class="console-header">
                            <span>TERMINAL</span>
                            <span style="cursor:pointer" onclick="clearLogs()">üö´ Limpar</span>
                            <span style="cursor:pointer; margin-left:10px;" onclick="toggleConsole()">‚¨á</span>
                        </div>
                        <div id="console-logs" class="console-logs"><div class="log-info">Code Studio V39 Ready.</div></div>
                        <div class="log-input-area">
                            <span style="color:#007bff; padding:10px;">></span>
                            <input type="text" id="console-cmd" placeholder="Comando JS..." onkeydown="handleCmd(event)">
                        </div>
                    </div>
                </div>
                <div class="toolbar">
                    <button class="tool-btn" onclick="toggleEditorFull()">‚õ∂</button>
                    <button class="tool-btn tb-console" onclick="toggleConsole()">üíª</button>
                    <button class="tool-btn tb-search" style="color:#007bff; border-color:#007bff;" onclick="toggleSearch()">üîç</button>
                    <button class="tool-btn tb-app" onclick="generateApp()">üì± APP</button>
                    <div style="width:1px; background:#444; margin:0 5px;"></div>
                    <button class="tool-btn tb-pink" onclick="triggerUpload('img')">üñºÔ∏è</button>
                    <button class="tool-btn tb-pink" style="background:#d63031" onclick="triggerUpload('3d')">üì¶</button>
                    <button class="tool-btn tb-purple" onclick="triggerUpload('audio')">üéµ</button>
                    <input type="file" id="up-img" hidden accept="image/*"><input type="file" id="up-3d" hidden accept=".glb,.gltf,.obj"><input type="file" id="up-audio" hidden accept="audio/*">
                    <div style="width:1px; background:#444; margin:0 5px;"></div>
                    <button class="tool-btn" onclick="selectAll()">ALL</button>
                    <button class="tool-btn" onclick="copyAll()">CPY</button>
                    <button class="tool-btn" onclick="pasteAll()">PST</button>
                    <div style="width:1px; background:#444; margin:0 5px;"></div>
                    <button class="tool-btn" style="color:#4da6ff" onclick="insert('<html>\\n<body>\\n</body>\\n</html>')">HTML</button>
                    <button class="tool-btn" style="color:#73c990" onclick="insert('body{margin:0}')">+CSS</button>
                    <button class="tool-btn" style="color:#73c990" onclick="insert('console.log(1)')">+JS</button>
                    <button class="tool-btn" style="color:#ffb74d" onclick="insert('<div></div>')">div</button>
                    <button class="tool-btn" style="color:#ffb74d" onclick="insert('class=\u0022\u0022')">class</button>
                    <button class="tool-btn" style="color:#ffb74d" onclick="insert('id=\u0022\u0022')">id</button>
                    <button class="tool-btn" onclick="insert('<')">&lt;</button>
                    <button class="tool-btn" onclick="insert('>')">&gt;</button>
                    <button class="tool-btn" onclick="insert('{')">{</button>
                    <button class="tool-btn" onclick="insert('}')">}</button>
                    <button class="tool-btn" onclick="insert(';')">;</button>
                    <button class="tool-btn" onclick="insert('=')">=</button>
                </div>
            </div>

            <div class="action-row">
                <button class="btn btn-trash" onclick="clearActive()">üóëÔ∏è</button>
                <button class="btn btn-dl" onclick="downloadZip()">üì¶ ZIP</button>
                <button class="btn btn-run" onclick="runCode()">‚ñ∂ RODAR</button>
            </div>

            <div class="recent-section">
                <h4 style="margin:0 0 10px 0; color:#888;">PROJETOS RECENTES</h4>
                <ul id="recent-list" style="list-style:none; padding:0; margin:0;"></ul>
                <div style="text-align:right; margin-top:5px;"><small style="color:#ff4d4d; cursor:pointer;" onclick="clearDB()">Limpar Tudo</small></div>
            </div>
        </div>

        <div id="view-help" class="view">
            <div class="scroll-view">
                <div class="help-card">
                    <span style="font-size:1.1rem; font-weight:bold; color:white;">üì± Criar App (PWA)</span>
                    <div style="background:#111; padding:10px; border-radius:6px; margin-top:10px; border:1px solid #333; font-size:13px; color:#aaa;">
                        1. Clique em <b>üì± APP</b>. 2. D√™ um nome. 3. O Code Studio cria o "manifest.json".<br>
                        Depois √© s√≥ usar "Adicionar √† Tela de In√≠cio" do navegador.
                    </div>
                </div>
                <div class="help-card">
                    <span style="font-size:1.1rem; font-weight:bold; color:white;">üìö C√≥digos Prontos</span>
                    <div class="snippet-item" onclick="copySnippet('gameloop')">Game Loop (Animation)</div>
                    <div class="snippet-item" onclick="copySnippet('keys')">Keyboard Input (PC)</div>
                    <div class="snippet-item" onclick="copySnippet('touch')">Touch Input (Mobile)</div>
                    <div class="snippet-item" onclick="copySnippet('audio')">Audio Play (Safe)</div>
                </div>
            </div>
        </div>
    </main>

    <div id="game-overlay"><button class="close-game" onclick="closeGame()">‚úï</button><iframe id="game-frame"></iframe></div>

    <script>
        let files = [{ id: 'f1', name: 'index.html', type: 'html', content: '<h1>Ol√° Mundo</h1>' }];
        let activeFileId = 'f1';
        let editorMode = 'multi'; 
        let currentProjectName = "";

        // --- ROTA√á√ÉO AUTOM√ÅTICA (ZEN MODE) ---
        window.addEventListener('resize', () => {
            if(window.innerWidth > window.innerHeight) {
                // Se a tela for paisagem (largura > altura), muda pro editor
                switchView('editor');
            }
        });

        // --- SISTEMA APP (ARQUIVOS NAS ABAS) ---
        function generateApp() {
            if(editorMode === 'single') { alert("Mude para o modo 'Abas' para gerar arquivos de App."); return; }
            const appName = prompt("Nome do App:", currentProjectName || "Meu Jogo");
            if(!appName) return;
            const manifest = {
                "name": appName, "short_name": appName, "start_url": "index.html", "display": "standalone",
                "background_color": "#000000", "theme_color": "#007bff",
                "icons": [ { "src": "https://cdn-icons-png.flaticon.com/512/5260/5260498.png", "sizes": "512x512", "type": "image/png" } ]
            };
            const swCode = `self.addEventListener('install',e=>{e.waitUntil(caches.open('${appName}').then(c=>c.addAll(['./','./index.html'])));});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});`;
            files.push({ id: 'f_man'+Date.now(), name: 'manifest.json', type: 'json', content: JSON.stringify(manifest, null, 2) });
            files.push({ id: 'f_sw'+Date.now(), name: 'sw.js', type: 'js', content: swCode });
            const idx = files.find(f => f.name === 'index.html');
            if(idx && !idx.content.includes('manifest.json')) {
                idx.content = idx.content.replace('<head>', `<head>\n<link rel="manifest" href="manifest.json">\n<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js');<\/script>`);
            }
            alert("Arquivos Criados! Veja nas abas: manifest.json e sw.js");
            renderTabs();
        }

        // --- EXPORTAR ZIP ---
        function downloadZip() {
            if(editorMode === 'single') { alert("Use o modo 'Abas' para ZIP."); return; }
            const zip = new JSZip();
            files.forEach(f => zip.file(f.name, f.content));
            zip.generateAsync({type:"blob"}).then(content => {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = (currentProjectName || "projeto") + ".zip";
                a.click();
            });
        }

        // --- CORE SYSTEM ---
        function toggleConsole() { document.getElementById('console-pane').classList.toggle('open'); }
        function logMsg(type, msg) { const l = document.getElementById('console-logs'); const d = document.createElement('div'); d.className = 'log-line log-'+type; d.innerText = `> ${msg}`; l.appendChild(d); l.scrollTop = l.scrollHeight; }
        function clearLogs() { document.getElementById('console-logs').innerHTML = ''; }
        function handleCmd(e) { if(e.key==='Enter'){ const c=e.target.value; logMsg('info',c); const f=document.getElementById('game-frame'); if(f.contentWindow){try{f.contentWindow.postMessage({type:'eval',code:c},'*')}catch(err){logMsg('error',err.message)}} e.target.value=''; } }
        window.addEventListener('message', (e) => { if(e.data?.type === 'console') { logMsg(e.data.level, e.data.text); if(e.data.level==='error') document.getElementById('console-pane').classList.add('open'); } });

        function triggerUpload(t) { document.getElementById('up-'+t).click(); document.getElementById('up-'+t).onchange=e=>processAsset(e.target,t); }
        function processAsset(i,t) { const f=i.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const d=e.target.result; const n="as_"+Math.random().toString(36).substr(2,4); let c=""; if(t==='img')c=confirm("Tag?")?`<img src="${d}">`:`'${d}'`; else if(t==='3d')c=`const m='${d}';`; else c=`const ${n}=new Audio('${d}');`; insert(c); }; r.readAsDataURL(f); i.value=''; }

        function selectAll() { getActiveEditorElement().select(); getActiveEditorElement().focus(); }
        function copyAll() { getActiveEditorElement().select(); document.execCommand('copy'); }
        async function pasteAll() { try{const t=await navigator.clipboard.readText(); insert(t);}catch(e){alert('Cole manualmente.');} }
        
        function copySnippet(t) { let x=""; if(t==='gameloop')x="function loop(){requestAnimationFrame(loop);}loop();"; else if(t==='keys')x="document.onkeydown=e=>{};"; else if(t==='touch')x="document.ontouchstart=e=>{};"; else x="snd.play().catch(console.error);"; const tmp=document.createElement('textarea'); tmp.value=x; document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp); alert("Copiado!"); }

        function toggleSearch() { document.getElementById('search-bar').classList.toggle('active'); if(document.getElementById('search-bar').classList.contains('active'))document.getElementById('search-input').focus(); }
        function findNext() { const ed=getActiveEditorElement(); const v=document.getElementById('search-input').value; if(!v)return; const i=ed.value.indexOf(v,ed.selectionEnd); if(i!==-1){ed.focus();ed.setSelectionRange(i,i+v.length);}else{alert("Fim.");} }
        function findPrev() { const ed=getActiveEditorElement(); const v=document.getElementById('search-input').value; if(!v)return; const i=ed.value.lastIndexOf(v,ed.selectionStart-1); if(i!==-1){ed.focus();ed.setSelectionRange(i,i+v.length);} }
        function updateLines() { const ed=getActiveEditorElement(); document.getElementById('line-numbers').innerHTML = Array(ed.value.split('\n').length).fill(0).map((_,i)=>i+1).join('<br>'); }
        function syncScroll() { document.getElementById('line-numbers').scrollTop = getActiveEditorElement().scrollTop; }

        function renderTabs() { if(editorMode==='single')return; const c=document.getElementById('tabs-container'); const k=c.querySelector('.tab-controls'); c.innerHTML=''; files.forEach(f=>{ const d=document.createElement('div'); d.className=`file-tab ${f.id===activeFileId?'active':''}`; d.onclick=()=>switchFile(f.id); d.innerHTML=`${f.name}`; if(f.name!=='index.html')d.innerHTML+=`<span style="margin-left:8px;color:#666" onclick="event.stopPropagation();closeFile('${f.id}')">√ó</span>`; c.appendChild(d); }); c.appendChild(k); renderEditors(); }
        function renderEditors() { const a=document.getElementById('editors-area'); if(editorMode==='single'){ a.querySelectorAll('.file-editor').forEach(e=>e.style.display='none'); document.getElementById('in-single').classList.add('active'); updateLines(); return; } document.getElementById('in-single').classList.remove('active'); files.forEach(f=>{ let t=document.getElementById('ed-'+f.id); if(!t){ t=document.createElement('textarea'); t.id='ed-'+f.id; t.className='code-input file-editor'; t.spellcheck=false; t.value=f.content; t.oninput=e=>{f.content=e.target.value; updateLines();}; t.onscroll=syncScroll; t.onkeydown=e=>checkTab(e); a.insertBefore(t,document.getElementById('console-pane')); } t.style.display=(f.id===activeFileId)?'block':'none'; }); updateLines(); }
        function switchFile(id) { activeFileId=id; renderTabs(); }
        function addNewFile() { const n=prompt("Nome:"); if(n){ const id='f_'+Date.now(); files.push({id,name:n,type:n.split('.').pop(),content:''}); switchFile(id); } }
        function closeFile(id) { if(confirm("Fechar?")){ files=files.filter(f=>f.id!==id); document.getElementById('ed-'+id)?.remove(); switchFile(files[0].id); } }
        function toggleEditorMode() { editorMode=editorMode==='multi'?'single':'multi'; document.getElementById('mode-icon').innerText=editorMode==='single'?'üìù':'üìö'; if(editorMode==='single')document.getElementById('in-single').value=compileProject(); renderTabs(); renderEditors(); }
        function compileProject() { const i=files.find(f=>f.name==='index.html'); if(!i)return""; let c=i.content; files.filter(f=>f.type==='css').forEach(f=>c+=`\n<style>\n/*${f.name}*/\n${f.content}\n</style>`); files.filter(f=>f.type==='js').forEach(f=>c+=`\n<script>\n//${f.name}\n${f.content}\n<\/script>`); return c; }
        function getActiveEditorElement() { return editorMode==='single'?document.getElementById('in-single'):document.getElementById('ed-'+activeFileId); }
        function insert(t) { const el=getActiveEditorElement(); const s=el.selectionStart; el.value=el.value.substring(0,s)+t+el.value.substring(el.selectionEnd); el.focus(); el.selectionStart=s+t.length; if(editorMode==='multi')files.find(f=>f.id===activeFileId).content=el.value; updateLines(); }
        function checkTab(e) { if(e.key=='Tab'){ e.preventDefault(); insert('    '); } }

        const DB_NAME="StudioV39"; let db; const req=indexedDB.open(DB_NAME,1); req.onupgradeneeded=e=>e.target.result.createObjectStore('projects',{keyPath:'id',autoIncrement:true}); req.onsuccess=e=>{db=e.target.result; renderHistory();};
        function saveToDB(n) { const d=editorMode==='multi'?"JSON::"+JSON.stringify(files):document.getElementById('in-single').value; db.transaction(['projects'],'readwrite').objectStore('projects').put({name:n,code:d,date:new Date().toLocaleDateString()}); renderHistory(); }
        function runCode() { const c=editorMode==='single'?document.getElementById('in-single').value:compileProject(); if(!currentProjectName)currentProjectName=prompt("Nome:")||"Proj"; saveToDB(currentProjectName); launchGame(c); }
        function downloadCode() { const c=editorMode==='single'?document.getElementById('in-single').value:compileProject(); const b = new Blob([c],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=(currentProjectName||'index')+'.html'; a.click(); }
        function launchGame(h) { document.getElementById('game-overlay').style.display='flex'; const inj=`<script>const send=(t,a)=>{try{window.parent.postMessage({type:'console',level:t,text:Array.from(a).join(' ')},'*')}catch(e){}};const oL=console.log;console.log=(...a)=>{oL(...a);send('info',a)};const oE=console.error;console.error=(...a)=>{oE(...a);send('error',a)};window.onerror=(m,u,l)=>{send('error',[m+" ("+l+")"])};window.addEventListener('message',e=>{if(e.data?.type==='eval'){try{console.log('Result:',eval(e.data.code))}catch(x){console.error(x)}}});try{localStorage}catch(e){window.localStorage={getItem:()=>null,setItem:()=>{}}}<\/script>`; document.getElementById('game-frame').srcdoc=h.includes('<head>')?h.replace('<head>','<head>'+inj):inj+h; }
        function closeGame() { document.getElementById('game-overlay').style.display='none'; document.getElementById('game-frame').srcdoc=''; }
        function toggleEditorFull() { document.getElementById('editor-container').classList.toggle('fullscreen-mode'); }
        function switchView(v) { document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); event.currentTarget.classList.add('active'); }
        function renderHistory() { const l=document.getElementById('recent-list'); l.innerHTML=''; db.transaction(['projects'],'readonly').objectStore('projects').getAll().onsuccess=e=>{ e.target.result.reverse().forEach(i=>{ l.innerHTML+=`<li class="recent-item"><span class="item-name" onclick="loadProject(${i.id})">${i.name}</span><div><button class="btn-act" style="background:#e67e22" onclick="renameP(${i.id},'${i.name}')">‚úèÔ∏è</button><button class="btn-act" style="background:#1976d2" onclick="dlP(${i.id})">üíæ</button><button class="btn-act" style="background:#d32f2f" onclick="delP(${i.id})">‚úï</button><button class="btn-act" style="background:#388e3c" onclick="playP(${i.id})">‚ñ∂</button></div></li>`; }); }; }
        function loadProject(id) { db.transaction(['projects'],'readonly').objectStore('projects').get(id).onsuccess=e=>{ const c=e.target.result.code; currentProjectName=e.target.result.name; if(c.startsWith("JSON::")){ files=JSON.parse(c.replace("JSON::","")); if(editorMode==='single')toggleEditorMode(); activeFileId=files[0].id; }else{ if(editorMode==='multi')toggleEditorMode(); document.getElementById('in-single').value=c; } switchView('editor'); renderTabs(); }; }
        function playP(id){ loadProject(id); setTimeout(()=>runCode(),200); }
        function renameP(id,o){ const n=prompt("Nome:",o); if(n){ const tx=db.transaction(['projects'],'readwrite'); const s=tx.objectStore('projects'); s.get(id).onsuccess=e=>{ e.target.result.name=n; s.put(e.target.result); renderHistory(); }; } }
        function delP(id){ if(confirm("Apagar?")){ db.transaction(['projects'],'readwrite').objectStore('projects').delete(id); setTimeout(renderHistory,100); } }
        function dlP(id){ loadProject(id); setTimeout(downloadZip, 200); } // ZIP
        function clearDB(){ if(confirm("Tudo?")){ db.transaction(['projects'],'readwrite').objectStore('projects').clear(); setTimeout(renderHistory,100); } }
        function clearActive(){ if(confirm("Limpar?")){ if(editorMode==='single')document.getElementById('in-single').value=''; else{ files.find(f=>f.id===activeFileId).content=''; renderEditors(); } } }
        function handleFile(i) { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ document.getElementById('in-single').value=e.target.result; if(editorMode==='multi')toggleEditorMode(); saveToDB(f.name.replace('.html','')); switchView('editor'); }; r.readAsText(f); }

        renderTabs();
    </script>
</body>
</html>
